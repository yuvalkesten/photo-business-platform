generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String              @id @default(cuid())
  name               String?
  email              String              @unique
  emailVerified      DateTime?
  image              String?
  password           String?
  role               UserRole            @default(PHOTOGRAPHER)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  businessName       String?
  businessLogo       String?
  businessEmail      String?
  businessPhone      String?
  timezone           String              @default("America/New_York")
  accounts           Account[]
  contacts           Contact[]
  emailWatch         EmailWatch?
  financialDocuments FinancialDocument[]
  galleries          Gallery[]
  instagramAccount   InstagramAccount?
  organizations      Organization[]
  processedEmails    ProcessedEmail[]
  processedMessages  ProcessedMessage[]
  projects           Project[]
  sessions           Session[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Contact {
  id              String           @id @default(cuid())
  userId          String
  firstName       String
  lastName        String
  email           String
  phone           String?
  organizationId  String?
  jobTitle        String?
  address         String?
  city            String?
  state           String?
  zipCode         String?
  website         String?
  type            ContactType      @default(LEAD)
  source          String?
  tags            String[]
  status          ContactStatus    @default(ACTIVE)
  notes           String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  organization    Organization?    @relation(fields: [organizationId], references: [id])
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  galleries         Gallery[]
  processedEmails   ProcessedEmail[]
  processedMessages ProcessedMessage[]
  projects          Project[]

  @@unique([userId, email])
  @@index([userId, type])
  @@index([userId, status])
  @@index([organizationId])
  @@map("contacts")
}

model Organization {
  id        String    @id @default(cuid())
  userId    String
  name      String
  type      OrgType?
  website   String?
  email     String?
  phone     String?
  address   String?
  city      String?
  state     String?
  zipCode   String?
  notes     String?
  tags      String[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  contacts  Contact[]
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  projects  Project[]

  @@unique([userId, name])
  @@index([userId])
  @@map("organizations")
}

model Project {
  id                String           @id @default(cuid())
  userId            String
  contactId         String
  organizationId    String?
  name              String
  description       String?
  projectType       ProjectType
  status            ProjectStatus    @default(INQUIRY)
  totalPrice        Decimal?         @db.Decimal(10, 2)
  deposit           Decimal?         @db.Decimal(10, 2)
  paidAmount        Decimal?         @db.Decimal(10, 2)
  source            String?
  notes             String?
  tags              String[]
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  completedAt       DateTime?
  bookedAt          DateTime?
  budgetMax         Decimal?         @db.Decimal(10, 2)
  budgetMin         Decimal?         @db.Decimal(10, 2)
  closeProbability  Int?             @default(50)
  eventDate         DateTime?
  expectedCloseDate DateTime?
  lastContactDate   DateTime?
  leadTemperature   LeadTemperature?
  lostNotes         String?
  lostReason        LostReason?
  nextFollowUpDate  DateTime?
  galleries         Gallery[]
  sessions          PhotoSession[]
  processedEmails   ProcessedEmail[]
  processedMessages ProcessedMessage[]
  contact           Contact          @relation(fields: [contactId], references: [id], onDelete: Cascade)
  organization      Organization?    @relation(fields: [organizationId], references: [id])
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([contactId])
  @@index([organizationId])
  @@index([userId, leadTemperature])
  @@index([userId, nextFollowUpDate])
  @@index([userId, eventDate])
  @@map("projects")
}

model PhotoSession {
  id               String             @id @default(cuid())
  projectId        String
  title            String
  description      String?
  scheduledAt      DateTime
  startTime        DateTime
  endTime          DateTime
  timezone         String             @default("America/New_York")
  location         String?
  locationNotes    String?
  googleEventId    String?            @unique
  googleCalendarId String?
  status           PhotoSessionStatus @default(SCHEDULED)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  project          Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([scheduledAt])
  @@map("photo_sessions")
}

model Gallery {
  id            String    @id @default(cuid())
  userId        String
  title         String
  description   String?
  coverImage    String?
  isPublic      Boolean   @default(false)
  password      String?
  shareToken    String    @unique @default(cuid())
  expiresAt     DateTime?
  allowDownload Boolean   @default(true)
  watermark     Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  contactId     String
  projectId     String
  contact       Contact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  project       Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  photos        Photo[]

  @@index([userId])
  @@index([projectId])
  @@index([contactId])
  @@index([shareToken])
  @@map("galleries")
}

model Photo {
  id           String   @id @default(cuid())
  galleryId    String
  filename     String
  s3Key        String   @unique
  s3Url        String
  thumbnailUrl String?
  fileSize     Int
  width        Int
  height       Int
  mimeType     String
  order        Int      @default(0)
  isFavorite   Boolean  @default(false)
  tags         String[]
  uploadedAt   DateTime @default(now())
  gallery      Gallery  @relation(fields: [galleryId], references: [id], onDelete: Cascade)

  @@index([galleryId, order])
  @@map("photos")
}

model EmailWatch {
  id          String   @id @default(cuid())
  userId      String   @unique
  historyId   String
  expiration  DateTime
  resourceUri String?
  isActive    Boolean  @default(true)
  lastSyncAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("email_watches")
}

model ProcessedEmail {
  id                 String               @id @default(cuid())
  userId             String
  gmailMessageId     String
  gmailThreadId      String?
  subject            String
  fromEmail          String
  fromName           String?
  receivedAt         DateTime
  snippet            String?
  classification     EmailClassification?
  classificationData String?
  classifiedAt       DateTime?
  status             ProcessingStatus     @default(PENDING)
  errorMessage       String?
  retryCount         Int                  @default(0)
  createdContactId   String?
  createdProjectId   String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  financialDocument  FinancialDocument?
  createdContact     Contact?             @relation(fields: [createdContactId], references: [id])
  createdProject     Project?             @relation(fields: [createdProjectId], references: [id])
  user               User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, gmailMessageId])
  @@index([userId, status])
  @@index([userId, classification])
  @@index([userId, receivedAt])
  @@map("processed_emails")
}

model FinancialDocument {
  id               String          @id @default(cuid())
  userId           String
  processedEmailId String?         @unique
  documentType     DocumentType
  amount           Decimal?        @db.Decimal(10, 2)
  currency         String          @default("USD")
  vendorName       String?
  vendorEmail      String?
  documentNumber   String?
  documentDate     DateTime?
  dueDate          DateTime?
  status           DocumentStatus  @default(PENDING_REVIEW)
  reviewedAt       DateTime?
  notes            String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  processedEmail   ProcessedEmail? @relation(fields: [processedEmailId], references: [id])
  user             User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, documentType])
  @@index([userId, status])
  @@map("financial_documents")
}

enum UserRole {
  PHOTOGRAPHER
  ADMIN
  CLIENT
}

enum ContactType {
  LEAD
  CLIENT
  PAST_CLIENT
  COLLABORATOR
  SUPPLIER
  REFERRAL_SOURCE
}

enum ContactStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum OrgType {
  COMPANY
  NGO
  VENUE
  VENDOR
  AGENCY
  OTHER
}

enum ProjectType {
  WEDDING
  ENGAGEMENT
  PORTRAIT
  FAMILY
  NEWBORN
  CORPORATE
  EVENT
  COMMERCIAL
  REAL_ESTATE
  OTHER
}

enum ProjectStatus {
  INQUIRY
  PROPOSAL_SENT
  BOOKED
  IN_PROGRESS
  POST_PRODUCTION
  DELIVERED
  COMPLETED
  CANCELLED
  ARCHIVED
}

enum LeadTemperature {
  HOT
  WARM
  COLD
}

enum LostReason {
  BUDGET
  TIMING
  COMPETITOR
  NO_RESPONSE
  SCOPE_MISMATCH
  PERSONAL_REASONS
  OTHER
}

enum PhotoSessionStatus {
  SCHEDULED
  COMPLETED
  RESCHEDULED
  CANCELLED
}

enum EmailClassification {
  INQUIRY
  URGENT_REQUEST
  INVOICE
  RECEIPT
  OTHER
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  CLASSIFIED
  ACTION_TAKEN
  SKIPPED
  FAILED
}

enum DocumentType {
  INVOICE
  RECEIPT
}

enum DocumentStatus {
  PENDING_REVIEW
  APPROVED
  REJECTED
  ARCHIVED
}

enum MessagePlatform {
  INSTAGRAM
  // Future: FACEBOOK, WHATSAPP
}

model InstagramAccount {
  id              String    @id @default(cuid())
  userId          String    @unique
  instagramUserId String    @unique
  username        String?
  accessToken     String    @db.Text
  tokenExpiresAt  DateTime?
  pageId          String?
  pageName        String?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("instagram_accounts")
}

model ProcessedMessage {
  id                 String              @id @default(cuid())
  userId             String
  platform           MessagePlatform     @default(INSTAGRAM)
  platformMessageId  String
  platformThreadId   String?
  senderName         String?
  senderHandle       String?
  senderId           String
  messageText        String              @db.Text
  receivedAt         DateTime
  classification     EmailClassification?
  classificationData String?             @db.Text
  classifiedAt       DateTime?
  status             ProcessingStatus    @default(PENDING)
  errorMessage       String?             @db.Text
  retryCount         Int                 @default(0)
  createdContactId   String?
  createdProjectId   String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdContact     Contact?            @relation(fields: [createdContactId], references: [id])
  createdProject     Project?            @relation(fields: [createdProjectId], references: [id])

  @@unique([userId, platform, platformMessageId])
  @@index([userId, status])
  @@index([userId, classification])
  @@index([userId, receivedAt])
  @@map("processed_messages")
}
