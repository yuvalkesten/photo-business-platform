generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String              @id @default(cuid())
  name               String?
  email              String              @unique
  emailVerified      DateTime?
  image              String?
  password           String?
  role               UserRole            @default(PHOTOGRAPHER)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  businessName       String?
  businessLogo       String?
  businessEmail      String?
  businessPhone      String?
  timezone           String              @default("America/New_York")
  watermarkUrl       String?
  watermarkPosition  String              @default("center")
  watermarkOpacity   Int                 @default(50)
  brandLogo          String?
  brandFavicon       String?
  brandPrimaryColor  String              @default("#000000")
  brandAccentColor   String              @default("#8b5cf6")
  accounts           Account[]
  contacts           Contact[]
  emailWatch         EmailWatch?
  financialDocuments FinancialDocument[]
  galleries          Gallery[]
  instagramAccount   InstagramAccount?
  organizations      Organization[]
  invoices           Invoice[]
  processedEmails    ProcessedEmail[]
  processedMessages  ProcessedMessage[]
  projects           Project[]
  sessions           Session[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Contact {
  id              String           @id @default(cuid())
  userId          String
  firstName       String
  lastName        String
  email           String
  phone           String?
  instagramHandle String?
  organizationId  String?
  jobTitle        String?
  address         String?
  city            String?
  state           String?
  zipCode         String?
  website         String?
  type            ContactType      @default(LEAD)
  source          String?
  tags            String[]
  status          ContactStatus    @default(ACTIVE)
  notes           String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  organization    Organization?    @relation(fields: [organizationId], references: [id])
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  galleries         Gallery[]
  processedEmails   ProcessedEmail[]
  processedMessages ProcessedMessage[]
  projects          Project[]

  @@unique([userId, email])
  @@index([userId, type])
  @@index([userId, status])
  @@index([userId, instagramHandle])
  @@index([organizationId])
  @@map("contacts")
}

model Organization {
  id        String    @id @default(cuid())
  userId    String
  name      String
  type      OrgType?
  website   String?
  email     String?
  phone     String?
  address   String?
  city      String?
  state     String?
  zipCode   String?
  notes     String?
  tags      String[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  contacts  Contact[]
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  projects  Project[]

  @@unique([userId, name])
  @@index([userId])
  @@map("organizations")
}

model Project {
  id                String           @id @default(cuid())
  userId            String
  contactId         String
  organizationId    String?
  name              String
  description       String?
  projectType       ProjectType
  status            ProjectStatus    @default(INQUIRY)
  totalPrice        Decimal?         @db.Decimal(10, 2)
  deposit           Decimal?         @db.Decimal(10, 2)
  paidAmount        Decimal?         @db.Decimal(10, 2)
  source            String?
  notes             String?
  tags              String[]
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  completedAt       DateTime?
  bookedAt          DateTime?
  budgetMax         Decimal?         @db.Decimal(10, 2)
  budgetMin         Decimal?         @db.Decimal(10, 2)
  closeProbability  Int?             @default(50)
  eventDate         DateTime?
  expectedCloseDate DateTime?
  lastContactDate   DateTime?
  leadTemperature   LeadTemperature?
  lostNotes         String?
  lostReason        LostReason?
  nextFollowUpDate  DateTime?
  galleries         Gallery[]
  invoices          Invoice[]
  sessions          PhotoSession[]
  processedEmails   ProcessedEmail[]
  processedMessages ProcessedMessage[]
  contact           Contact          @relation(fields: [contactId], references: [id], onDelete: Cascade)
  organization      Organization?    @relation(fields: [organizationId], references: [id])
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([contactId])
  @@index([organizationId])
  @@index([userId, leadTemperature])
  @@index([userId, nextFollowUpDate])
  @@index([userId, eventDate])
  @@map("projects")
}

model PhotoSession {
  id               String             @id @default(cuid())
  projectId        String
  title            String
  description      String?
  scheduledAt      DateTime
  startTime        DateTime
  endTime          DateTime
  timezone         String             @default("America/New_York")
  location         String?
  locationNotes    String?
  googleEventId    String?            @unique
  googleCalendarId String?
  status           PhotoSessionStatus @default(SCHEDULED)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  project          Project            @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([scheduledAt])
  @@map("photo_sessions")
}

model Gallery {
  id            String           @id @default(cuid())
  userId        String
  title         String
  description   String?
  coverImage    String?
  isPublic      Boolean          @default(false)
  password      String?
  shareToken    String           @unique @default(cuid())
  expiresAt     DateTime?
  allowDownload Boolean          @default(true)
  watermark     Boolean          @default(false)
  requireEmail  Boolean          @default(false)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  contactId     String
  projectId     String

  // Theming
  theme              String   @default("classic")
  gridStyle          String   @default("grid")
  fontFamily         String   @default("inter")
  primaryColor       String   @default("#000000")
  accentColor        String   @default("#8b5cf6")

  // Download options
  downloadResolution String   @default("original")
  favoriteLimit      Int?

  // AI Search
  aiSearchEnabled          Boolean  @default(false)
  analysisProgress         Int      @default(0)
  lastAnalysisTriggeredAt  DateTime?

  contact        Contact          @relation(fields: [contactId], references: [id], onDelete: Cascade)
  project        Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user           User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  photos         Photo[]
  photoSets      PhotoSet[]
  visitors       GalleryVisitor[]
  favoriteLists  FavoriteList[]
  downloadEvents DownloadEvent[]
  photoAnalyses  PhotoAnalysis[]
  personClusters PersonCluster[]

  @@index([userId])
  @@index([projectId])
  @@index([contactId])
  @@index([shareToken])
  @@map("galleries")
}

model PhotoSet {
  id          String  @id @default(cuid())
  galleryId   String
  name        String
  description String?
  coverImage  String?
  order       Int     @default(0)
  gallery     Gallery @relation(fields: [galleryId], references: [id], onDelete: Cascade)
  photos      Photo[]

  @@index([galleryId, order])
  @@map("photo_sets")
}

model Photo {
  id              String          @id @default(cuid())
  galleryId       String
  filename        String
  s3Key           String          @unique
  s3Url           String
  thumbnailUrl    String?
  watermarkedUrl  String?
  fileSize        Int
  width           Int
  height          Int
  mimeType        String
  order           Int             @default(0)
  isFavorite      Boolean         @default(false)
  tags            String[]
  uploadedAt      DateTime        @default(now())
  setId           String?
  gallery         Gallery         @relation(fields: [galleryId], references: [id], onDelete: Cascade)
  set             PhotoSet?       @relation(fields: [setId], references: [id], onDelete: SetNull)
  favoritePhotos  FavoritePhoto[]
  analysis        PhotoAnalysis?

  @@index([galleryId, order])
  @@index([setId])
  @@map("photos")
}

model GalleryVisitor {
  id        String   @id @default(cuid())
  galleryId String
  email     String
  name      String?
  visitedAt DateTime @default(now())
  gallery   Gallery  @relation(fields: [galleryId], references: [id], onDelete: Cascade)

  @@unique([galleryId, email])
  @@index([galleryId])
  @@map("gallery_visitors")
}

model FavoriteList {
  id          String          @id @default(cuid())
  galleryId   String
  name        String?
  email       String
  note        String?
  submittedAt DateTime?
  createdAt   DateTime        @default(now())
  gallery     Gallery         @relation(fields: [galleryId], references: [id], onDelete: Cascade)
  photos      FavoritePhoto[]

  @@index([galleryId])
  @@map("favorite_lists")
}

model FavoritePhoto {
  id             String       @id @default(cuid())
  favoriteListId String
  photoId        String
  note           String?
  comment        String?
  favoriteList   FavoriteList @relation(fields: [favoriteListId], references: [id], onDelete: Cascade)
  photo          Photo        @relation(fields: [photoId], references: [id], onDelete: Cascade)

  @@unique([favoriteListId, photoId])
  @@map("favorite_photos")
}

model DownloadEvent {
  id           String   @id @default(cuid())
  galleryId    String
  photoId      String?
  visitorEmail String?
  resolution   String
  type         String
  createdAt    DateTime @default(now())
  gallery      Gallery  @relation(fields: [galleryId], references: [id], onDelete: Cascade)

  @@index([galleryId, createdAt])
  @@map("download_events")
}

model EmailWatch {
  id          String   @id @default(cuid())
  userId      String   @unique
  historyId   String
  expiration  DateTime
  resourceUri String?
  isActive    Boolean  @default(true)
  lastSyncAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("email_watches")
}

model ProcessedEmail {
  id                 String               @id @default(cuid())
  userId             String
  gmailMessageId     String
  gmailThreadId      String?
  subject            String
  fromEmail          String
  fromName           String?
  receivedAt         DateTime
  snippet            String?
  classification     EmailClassification?
  classificationData String?
  classifiedAt       DateTime?
  status             ProcessingStatus     @default(PENDING)
  errorMessage       String?
  retryCount         Int                  @default(0)
  createdContactId   String?
  createdProjectId   String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  financialDocument  FinancialDocument?
  createdContact     Contact?             @relation(fields: [createdContactId], references: [id])
  createdProject     Project?             @relation(fields: [createdProjectId], references: [id])
  user               User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, gmailMessageId])
  @@index([userId, status])
  @@index([userId, classification])
  @@index([userId, receivedAt])
  @@map("processed_emails")
}

model Invoice {
  id            String        @id @default(cuid())
  invoiceNumber String        @unique
  userId        String
  projectId     String

  // Amounts
  subtotal      Decimal       @db.Decimal(10, 2)
  tax           Decimal?      @db.Decimal(10, 2)
  taxRate       Decimal?      @db.Decimal(5, 2)
  total         Decimal       @db.Decimal(10, 2)
  amountPaid    Decimal       @default(0) @db.Decimal(10, 2)

  // Dates
  invoiceDate   DateTime      @default(now())
  dueDate       DateTime
  paidAt        DateTime?

  // Status
  status        InvoiceStatus @default(DRAFT)

  // Content
  lineItems     Json          // [{description, quantity, unitPrice, amount}]
  notes         String?

  // Tracking
  sentAt        DateTime?
  sentToEmail   String?

  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  project       Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([projectId])
  @@index([userId, status])
  @@map("invoices")
}

model FinancialDocument {
  id               String          @id @default(cuid())
  userId           String
  processedEmailId String?         @unique
  documentType     DocumentType
  amount           Decimal?        @db.Decimal(10, 2)
  currency         String          @default("USD")
  vendorName       String?
  vendorEmail      String?
  documentNumber   String?
  documentDate     DateTime?
  dueDate          DateTime?
  status           DocumentStatus  @default(PENDING_REVIEW)
  reviewedAt       DateTime?
  notes            String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  processedEmail   ProcessedEmail? @relation(fields: [processedEmailId], references: [id])
  user             User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, documentType])
  @@index([userId, status])
  @@map("financial_documents")
}

enum UserRole {
  PHOTOGRAPHER
  ADMIN
  CLIENT
}

enum ContactType {
  LEAD
  CLIENT
  PAST_CLIENT
  COLLABORATOR
  SUPPLIER
  REFERRAL_SOURCE
}

enum ContactStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum OrgType {
  COMPANY
  NGO
  VENUE
  VENDOR
  AGENCY
  OTHER
}

enum ProjectType {
  WEDDING
  ENGAGEMENT
  PORTRAIT
  FAMILY
  NEWBORN
  CORPORATE
  EVENT
  COMMERCIAL
  REAL_ESTATE
  OTHER
}

enum ProjectStatus {
  INQUIRY
  PROPOSAL_SENT
  BOOKED
  IN_PROGRESS
  POST_PRODUCTION
  DELIVERED
  COMPLETED
  CANCELLED
  ARCHIVED
}

enum LeadTemperature {
  HOT
  WARM
  COLD
}

enum LostReason {
  BUDGET
  TIMING
  COMPETITOR
  NO_RESPONSE
  SCOPE_MISMATCH
  PERSONAL_REASONS
  OTHER
}

enum PhotoSessionStatus {
  SCHEDULED
  COMPLETED
  RESCHEDULED
  CANCELLED
}

enum EmailClassification {
  INQUIRY
  URGENT_REQUEST
  INVOICE
  RECEIPT
  OTHER
}

enum ProcessingStatus {
  PENDING
  PROCESSING
  CLASSIFIED
  ACTION_TAKEN
  SKIPPED
  FAILED
}

enum DocumentType {
  INVOICE
  RECEIPT
}

enum DocumentStatus {
  PENDING_REVIEW
  APPROVED
  REJECTED
  ARCHIVED
}

enum InvoiceStatus {
  DRAFT
  SENT
  VIEWED
  PAID
  OVERDUE
  CANCELLED
}

enum MessagePlatform {
  INSTAGRAM
  // Future: FACEBOOK, WHATSAPP
}

enum AnalysisStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model PhotoAnalysis {
  id            String         @id @default(cuid())
  photoId       String         @unique
  galleryId     String
  status        AnalysisStatus @default(PENDING)
  description   String?        @db.Text
  analysisData  Json?
  searchTags    String[]
  faceData      Json?
  faceCount     Int            @default(0)
  errorMessage  String?
  retryCount    Int            @default(0)
  analyzedAt    DateTime?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  photo   Photo   @relation(fields: [photoId], references: [id], onDelete: Cascade)
  gallery Gallery @relation(fields: [galleryId], references: [id], onDelete: Cascade)

  @@index([galleryId, status])
  @@index([galleryId])
  @@map("photo_analyses")
}

model PersonCluster {
  id              String   @id @default(cuid())
  galleryId       String
  name            String?
  description     String?  @db.Text
  role            String?
  photoIds        String[]
  faceDescription String?  @db.Text
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  gallery Gallery @relation(fields: [galleryId], references: [id], onDelete: Cascade)

  @@index([galleryId])
  @@map("person_clusters")
}

model InstagramAccount {
  id              String    @id @default(cuid())
  userId          String    @unique
  instagramUserId String    @unique
  username        String?
  accessToken     String    @db.Text
  tokenExpiresAt  DateTime?
  pageId          String?
  pageName        String?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("instagram_accounts")
}

model ProcessedMessage {
  id                 String              @id @default(cuid())
  userId             String
  platform           MessagePlatform     @default(INSTAGRAM)
  platformMessageId  String
  platformThreadId   String?
  senderName         String?
  senderHandle       String?
  senderId           String
  messageText        String              @db.Text
  receivedAt         DateTime
  classification     EmailClassification?
  classificationData String?             @db.Text
  classifiedAt       DateTime?
  status             ProcessingStatus    @default(PENDING)
  errorMessage       String?             @db.Text
  retryCount         Int                 @default(0)
  createdContactId   String?
  createdProjectId   String?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdContact     Contact?            @relation(fields: [createdContactId], references: [id])
  createdProject     Project?            @relation(fields: [createdProjectId], references: [id])

  @@unique([userId, platform, platformMessageId])
  @@index([userId, status])
  @@index([userId, classification])
  @@index([userId, receivedAt])
  @@map("processed_messages")
}
